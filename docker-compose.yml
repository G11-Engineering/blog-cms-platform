version: '3.8'

services:
  # User Service Database
  postgres-user:
    image: postgres:15
    environment:
      POSTGRES_DB: ${POSTGRES_USER_DB:-user_service}
      POSTGRES_USER: ${POSTGRES_USER_USER:-user_service}
      POSTGRES_PASSWORD: ${POSTGRES_USER_PASSWORD:-user_password}
    ports:
      - "${POSTGRES_USER_PORT:-5433}:5432"
    volumes:
      - postgres_user_data:/var/lib/postgresql/data
    networks:
      - cms-network

  # Content Service Database
  postgres-content:
    image: postgres:15
    environment:
      POSTGRES_DB: ${POSTGRES_CONTENT_DB:-content_service}
      POSTGRES_USER: ${POSTGRES_CONTENT_USER:-content_service}
      POSTGRES_PASSWORD: ${POSTGRES_CONTENT_PASSWORD:-content_password}
    ports:
      - "${POSTGRES_CONTENT_PORT:-5434}:5432"
    volumes:
      - postgres_content_data:/var/lib/postgresql/data
    networks:
      - cms-network

  # Media Service Database
  postgres-media:
    image: postgres:15
    environment:
      POSTGRES_DB: ${POSTGRES_MEDIA_DB:-media_service}
      POSTGRES_USER: ${POSTGRES_MEDIA_USER:-media_service}
      POSTGRES_PASSWORD: ${POSTGRES_MEDIA_PASSWORD:-media_password}
    ports:
      - "${POSTGRES_MEDIA_PORT:-5435}:5432"
    volumes:
      - postgres_media_data:/var/lib/postgresql/data
    networks:
      - cms-network

  # Category Service Database
  postgres-category:
    image: postgres:15
    environment:
      POSTGRES_DB: ${POSTGRES_CATEGORY_DB:-category_service}
      POSTGRES_USER: ${POSTGRES_CATEGORY_USER:-category_service}
      POSTGRES_PASSWORD: ${POSTGRES_CATEGORY_PASSWORD:-category_password}
    ports:
      - "${POSTGRES_CATEGORY_PORT:-5436}:5432"
    volumes:
      - postgres_category_data:/var/lib/postgresql/data
    networks:
      - cms-network

  # Comment Service Database
  postgres-comment:
    image: postgres:15
    environment:
      POSTGRES_DB: ${POSTGRES_COMMENT_DB:-comment_service}
      POSTGRES_USER: ${POSTGRES_COMMENT_USER:-comment_service}
      POSTGRES_PASSWORD: ${POSTGRES_COMMENT_PASSWORD:-comment_password}
    ports:
      - "${POSTGRES_COMMENT_PORT:-5437}:5432"
    volumes:
      - postgres_comment_data:/var/lib/postgresql/data
    networks:
      - cms-network

  # User Service
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile.dev
    ports:
      - "${USER_SERVICE_PORT:-3001}:3001"
    env_file:
      - .env
      - ./services/user-service/.env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_USER_USER:-user_service}:${POSTGRES_USER_PASSWORD:-user_password}@postgres-user:5432/${POSTGRES_USER_DB:-user_service}
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://localhost:3001}
      # Asgardeo SSO Configuration (Frontend Authentication)
      ASGARDEO_BASE_URL: https://api.asgardeo.io/t/${ASGARDEO_ORG_NAME:-}
      ASGARDEO_CLIENT_ID: ${ASGARDEO_CLIENT_ID:-}
      # Asgardeo M2M Configuration (User Status Sync)
      ASGARDEO_M2M_CLIENT_ID: ${ASGARDEO_M2M_CLIENT_ID:-}
      ASGARDEO_M2M_CLIENT_SECRET: ${ASGARDEO_M2M_CLIENT_SECRET:-}
      ASGARDEO_ORG_NAME: ${ASGARDEO_ORG_NAME:-}
    depends_on:
      - postgres-user
    networks:
      - cms-network
    volumes:
      - ./database:/database

  # Content Service
  content-service:
    build:
      context: ./services/content-service
      dockerfile: Dockerfile.dev
    ports:
      - "${CONTENT_SERVICE_PORT:-3002}:3002"
    env_file:
      - .env
      - ./services/content-service/.env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3002
      DATABASE_URL: postgresql://${POSTGRES_CONTENT_USER:-content_service}:${POSTGRES_CONTENT_PASSWORD:-content_password}@postgres-content:5432/${POSTGRES_CONTENT_DB:-content_service}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      CONTENT_SERVICE_URL: ${CONTENT_SERVICE_URL:-http://localhost:3002}
      CATEGORY_SERVICE_URL: ${CATEGORY_SERVICE_URL:-http://category-service:3004}
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key}
    depends_on:
      - postgres-content
      - category-service
    networks:
      - cms-network
    volumes:
      - ./services/content-service:/app
      - ./database:/database
      - /app/node_modules
    command: ["npm", "run", "dev"]

  # Media Service
  media-service:
    build:
      context: ./services/media-service
      dockerfile: Dockerfile.dev
    ports:
      - "${MEDIA_SERVICE_PORT:-3003}:3003"
    env_file:
      - .env
      - ./services/media-service/.env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3003
      DATABASE_URL: postgresql://${POSTGRES_MEDIA_USER:-media_service}:${POSTGRES_MEDIA_PASSWORD:-media_password}@postgres-media:5432/${POSTGRES_MEDIA_DB:-media_service}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      MEDIA_SERVICE_URL: ${MEDIA_SERVICE_URL:-http://localhost:3003}
      UPLOAD_PATH: ${UPLOAD_PATH:-/app/uploads}
      # S3 Configuration (optional - if not set, will use local storage)
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-blog-cms-media}
      AWS_S3_ENDPOINT: ${AWS_S3_ENDPOINT:-}
      AWS_S3_FOLDER: ${AWS_S3_FOLDER:-uploads}
      # S3 Configuration (uncomment and set if using S3)
      # S3_BUCKET: ${S3_BUCKET}
      # S3_REGION: ${S3_REGION}
      # S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      # S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      # S3_ENDPOINT: ${S3_ENDPOINT}
      # Cloudflare R2 Configuration (uncomment and set if using R2)
      # R2_BUCKET: ${R2_BUCKET}
      # R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID}
      # R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY}
      # R2_ENDPOINT: ${R2_ENDPOINT}
      # R2_PUBLIC_URL: ${R2_PUBLIC_URL}
      # CDN Configuration
      # CDN_URL: ${CDN_URL}
    depends_on:
      - postgres-media
    networks:
      - cms-network
    volumes:
      - ./services/media-service:/app
      - ./database:/database
      - /app/node_modules
      - /app/dist
      - media_uploads:/app/uploads

  # Category Service
  category-service:
    build:
      context: ./services/category-service
      dockerfile: Dockerfile.dev
    ports:
      - "${CATEGORY_SERVICE_PORT:-3004}:3004"
    env_file:
      - .env
      - ./services/category-service/.env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3004
      DATABASE_URL: postgresql://${POSTGRES_CATEGORY_USER:-category_service}:${POSTGRES_CATEGORY_PASSWORD:-category_password}@postgres-category:5432/${POSTGRES_CATEGORY_DB:-category_service}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      CATEGORY_SERVICE_URL: ${CATEGORY_SERVICE_URL:-http://localhost:3004}
    depends_on:
      - postgres-category
    networks:
      - cms-network
    volumes:
      - ./services/category-service:/app
      - ./database:/database
      - /app/node_modules
    command: ["npm", "run", "dev"]

  # Comment Service
  comment-service:
    build:
      context: ./services/comment-service
      dockerfile: Dockerfile.dev
    ports:
      - "${COMMENT_SERVICE_PORT:-3005}:3005"
    env_file:
      - .env
      - ./services/comment-service/.env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3005
      DATABASE_URL: postgresql://${POSTGRES_COMMENT_USER:-comment_service}:${POSTGRES_COMMENT_PASSWORD:-comment_password}@postgres-comment:5432/${POSTGRES_COMMENT_DB:-comment_service}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      COMMENT_SERVICE_URL: ${COMMENT_SERVICE_URL:-http://localhost:3005}
    depends_on:
      - postgres-comment
    networks:
      - cms-network
    volumes:
      - ./services/comment-service:/app
      - ./database:/database
      - /app/node_modules
      - /app/dist

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    env_file:
      - .env
      - ./frontend/.env.local
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost}
      NEXT_PUBLIC_USER_SERVICE_URL: ${NEXT_PUBLIC_USER_SERVICE_URL:-http://localhost:3001}
      NEXT_PUBLIC_CONTENT_SERVICE_URL: ${NEXT_PUBLIC_CONTENT_SERVICE_URL:-http://localhost:3002}
      NEXT_PUBLIC_MEDIA_SERVICE_URL: ${NEXT_PUBLIC_MEDIA_SERVICE_URL:-http://localhost:3003}
      NEXT_PUBLIC_CATEGORY_SERVICE_URL: ${NEXT_PUBLIC_CATEGORY_SERVICE_URL:-http://localhost:3004}
      NEXT_PUBLIC_COMMENT_SERVICE_URL: ${NEXT_PUBLIC_COMMENT_SERVICE_URL:-http://localhost:3005}
      NEXT_PUBLIC_IMAGE_DOMAIN: ${NEXT_PUBLIC_IMAGE_DOMAIN:-localhost}
      NEXT_PUBLIC_IMAGE_PORT: ${NEXT_PUBLIC_IMAGE_PORT:-3003}
      # Asgardeo Configuration
      NEXT_PUBLIC_ASGARDEO_BASE_URL: ${NEXT_PUBLIC_ASGARDEO_BASE_URL:-}
      NEXT_PUBLIC_ASGARDEO_CLIENT_ID: ${NEXT_PUBLIC_ASGARDEO_CLIENT_ID:-}
      NEXT_PUBLIC_ASGARDEO_REDIRECT_URL: ${NEXT_PUBLIC_ASGARDEO_REDIRECT_URL:-http://localhost:3000}
      NEXT_PUBLIC_ASGARDEO_SCOPE: ${NEXT_PUBLIC_ASGARDEO_SCOPE:-openid profile email}
    depends_on:
      - user-service
      - content-service
      - media-service
      - category-service
      - comment-service
    networks:
      - cms-network
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    command: ["npm", "run", "dev"]

volumes:
  postgres_user_data:
  postgres_content_data:
  postgres_media_data:
  postgres_category_data:
  postgres_comment_data:
  media_uploads:

networks:
  cms-network:
    driver: bridge
